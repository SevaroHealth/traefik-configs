http:
  routers:
    nginx-server-a:
      entryPoints: [web]
      rule: "Host(`nginx-server-a.cloud.mysevaro.com`)"
      priority: 2
      middlewares: [nginx-a-ratelimit, nginx-a-retry, waf,http-cache]
      service: "nginx-server-a@ecs"

    nginx-server-a-socketio:
      entryPoints: [web]
      rule: "Host(`nginx-server-a.cloud.mysevaro.com`) && PathPrefix(`/socket.io`)"
      priority: 10
      middlewares: [nginx-a-ratelimit, nginx-a-retry]
      service: "nginx-server-a-sticky@ecs"

  middlewares:
    nginx-a-ratelimit:
      rateLimit:
        average: 99
        burst: 200

    nginx-a-retry:
      retry:
        attempts: 2
        initialInterval: 200ms

    http-cache:
      plugin:
        httpCache:
          maxTtl: 600 
          store:
            memory:
              limit: "3Gi"

    waf:
      plugin:
        coraza:
          crsEnabled: true
          directives:
            - SecDefaultAction "phase:1,log,auditlog,deny,status:403"
            - SecDefaultAction "phase:2,log,auditlog,deny,status:403"
            - SecAction "id:900110, phase:1, pass, t:none, nolog, setvar:tx.inbound_anomaly_score_threshold=5, setvar:tx.outbound_anomaly_score_threshold=4"
            - SecAction "id:900200, phase:1, pass, t:none, nolog, setvar:'tx.allowed_methods=GET'"
            - Include @owasp_crs/REQUEST-911-METHOD-ENFORCEMENT.conf
            - Include @owasp_crs/REQUEST-949-BLOCKING-EVALUATION.conf

            
